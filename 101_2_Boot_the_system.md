## 101.2 Загрузка системы

Чтобы управлять машиной, основной компонент операционной системы — ядро ​​— должен быть загружен загрузчиком, который в свою очередь загружается предустановленной прошивкой, такой как BIOS или UEFI. После загрузки, ядро ​​продолжает процесс загрузки, идентифицируя и настраивая оборудование. Наконец, ядро ​​вызывает утилиту, отвечающую за запуск и управление службами системы. Этой утилитой является - Init.

Процесс загрузки выглядит следующим образом:

1. BIOS/UEFI
2. MBR - первый этам загрузчика.
3. LILO/GRUB - второй этап загрузчика.
4. Linux Kernel - запуск ядра ОС.
5. Init - пользовательская среда.

## Инициализация операционной системы

Инициализация операционной системы начинается, когда загрузчик загружает ядро ​​в ОЗУ. Затем ядро ​​берет на себя управление ЦП и начинает обнаруживать и настраивать основные аспекты операционной системы, такие как базовая конфигурация оборудования и адресация памяти.

Затем ядро ​​открывает initramfs. **Initramfs — это архив, содержащий начальную файловую систему**, используемую как временная корневая файловая система во время процесса загрузки. Основное назначение файла `initramfs` — монтирование реального корня файловой системы, чтобы ядро ​​могло получить доступ к этой файловой системе ОС.

Как только корневая файловая система станет доступна, ядро ​​смонтирует все файловые системы, настроенные в `/etc/fstab`, а затем выполнит первую программу — утилиту с именем `init`. Программа `init` отвечает за запуск всех скриптов инициализации и системных демонов. Существуют различные реализации таких системных инициаторов, помимо традиционного `init`, такие как `systemd` и `Upstart`. После загрузки программы `init` `initramfs` удаляется из оперативной памяти.

`Стандарт SysV`
Менеджер служб, основанный на стандарте SysVinit, контролирует, какие демоны и ресурсы будут доступны, используя концепцию уровней выполнения. Уровни выполнения пронумерованы от 0 до 6 и разработаны разработчиками дистрибутивов для выполнения определенных целей. Единственными определениями уровней выполнения, общими для всех дистрибутивов, являются уровни выполнения 0, 1 и 6.

`systemd`
systemd — это современный менеджер систем и служб с уровнем совместимости для команд и уровней выполнения SysV. systemd имеет параллельную структуру, использует сокеты и D-Bus для активации служб, выполнения демонов по требованию, мониторинга процессов с помощью cgroups, поддержки снимков, восстановления системных сеансов, управления точками монтирования и управления службами на основе зависимостей. В последние годы большинство основных дистрибутивов Linux постепенно приняли systemd в качестве своего системного менеджера по умолчанию.

`Upstart`
Как и systemd, Upstart является заменой init. Цель Upstart — ускорить процесс загрузки путем распараллеливания процесса загрузки системных служб. Upstart использовался в дистрибутивах на базе Ubuntu в прошлых выпусках, но сегодня уступил место systemd.


## Проверки инициализации

Ошибки могут возникать во время процесса загрузки, но они могут быть не настолько критичны, чтобы полностью остановить операционную систему. Тем не менее, эти ошибки могут поставить под угрозу ожидаемое поведение системы. Все ошибки приводят к сообщениям, которые могут быть использованы для будущих расследований, поскольку они содержат ценную информацию о том, когда и как произошла ошибка. Даже если сообщения об ошибках не генерируются, информация, собранная во время процесса загрузки, может быть полезна для настройки и конфигурации.

Пространство памяти, в котором ядро ​​хранит свои сообщения, включая сообщения загрузки, называется кольцевым буфером ядра. Сообщения хранятся в кольцевом буфере ядра, даже если они не отображаются во время процесса инициализации, например, когда вместо этого отображается анимация. Однако кольцевой буфер ядра теряет все сообщения при выключении системы или при выполнении команды dmesg --clear. Без параметров команда dmesg отображает текущие сообщения в кольцевом буфере ядра:

```
dmesg
[    4.287300] mei_hdcp 0000:00:16.0-b638ab7e-94e2-4ea2-a552-d1c54b627f04: bound 0000:00:02.0 (ops i915_hdcp_component_ops [i915])
[    4.289408] e1000e 0000:00:1f.6 0000:00:1f.6 (uninitialized): registered PHC clock
```

Вывод `dmesg` может быть длиной в сотни строк, поэтому предыдущий листинг содержит только отрывок, показывающий, как ядро ​​вызывает диспетчер служб systemd. Значения в начале строк — это количество секунд относительно начала загрузки ядра.

В системах на базе `systemd` команда `journalctl` покажет сообщения инициализации с параметрами `-b`, `--boot`, `-k` или `--dmesg`. Команда `journalctl --list-boots` показывает список номеров загрузок относительно текущей загрузки, их идентификационный хэш и временные метки первого и последнего соответствующих сообщений:

```
journalctl --list-boots
  -3 155a8d270e5142918712e09e41b78a5e Thu 2024-11-28 09:20:49 MSK—Thu 2024-11-28 18:02:30 MSK
  -2 a1845512c876443194ef1b6e16084d73 Fri 2024-11-29 09:01:00 MSK—Fri 2024-11-29 18:03:38 MSK
  -1 946bd44262f24059b1c9011f69a0d118 Tue 2024-12-03 08:58:34 MSK—Tue 2024-12-03 18:01:54 MSK
   0 5d8171be33db4ebd9d1ef679d200144e Wed 2024-12-04 08:57:18 MSK—Wed 2024-12-04 16:34:51 MSK
```
Журналы предыдущей инициализации также хранятся в системах на основе systemd, поэтому сообщения из предыдущих сеансов операционной системы все еще могут быть просмотрены. Если указаны параметры `-b 0` или `--boot=0`, то будут показаны сообщения для текущей загрузки. Параметры `-b -1` или `--boot=-1` покажут сообщения из предыдущей инициализации. Параметры `-b -2` или `--boot=-2` покажут сообщения из инициализации до этого и так далее. Следующий фрагмент показывает, как ядро ​​вызывает диспетчер служб `systemd` для последнего процесса инициализации:

```
journalctl -b 0
ноя 21 11:05:01 ptrt-ws-0170.corp.cosmosgroup.ru kernel: microcode: microcode updated early to revision 0x35, date = 2023-12-05
ноя 21 11:05:01 ptrt-ws-0170.corp.cosmosgroup.ru kernel: Linux version 6.1.79-un-def-alt1 (builder@localhost.localdomain) (gcc-10 (GCC) 10.3.1 20210703 (ALT Sisyphus 10.3.1-alt2), GNU ld (GNU Binutils) 2.35>
ноя 21 11:05:01 ptrt-ws-0170.corp.cosmosgroup.ru kernel: Command line: BOOT_IMAGE=/boot/vmlinuz-un-def root=UUID=279b7bd5-0d03-4ff2-b5ff-1512f5a5978b ro resume=/dev/disk/by-uuid/ed49a15e-50b0-4f97-aa01-bf50>
ноя 21 11:05:01 ptrt-ws-0170.corp.cosmosgroup.ru kernel: KERNEL supported cpus:
ноя 21 11:05:01 ptrt-ws-0170.corp.cosmosgroup.ru kernel: tsc: Detected 1996.800 MHz TS
```

Инициализация и другие сообщения, выдаваемые операционной системой, хранятся в файлах внутри каталога `/var/log/`. Если происходит критическая ошибка и операционная система не может продолжить процесс инициализации после загрузки ядра и `initramfs`, можно использовать альтернативный загрузочный носитель, например, LiveCD, для запуска системы и доступа к соответствующей файловой системе. Затем можно выполнить поиск файлов в каталоге `/var/log/` на предмет возможных причин прерывания процесса загрузки. Параметры `-D` или `--directory` команды `journalctl` можно использовать для чтения сообщений журнала в каталогах, отличных от `/var/log/journal/`, который является расположением по умолчанию для сообщений журнала `systemd`. Поскольку сообщения журнала `systemd` не хранятся в виде необработанного текста, для их чтения требуется команда `journalctl`.

