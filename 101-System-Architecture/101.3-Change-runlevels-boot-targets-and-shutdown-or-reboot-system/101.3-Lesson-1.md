# 101.3 Изменение уровней запуска/целей загрузки и выключение или перезагрузка системы

Key knowledge areas

- Установка уровня запуска или цели загрузки по умолчанию.
- Изменение между уровнями запуска/целями загрузки, включая однопользовательский режим.
- Завершение работы и перезагрузка из командной строки.
- Предупреждать пользователей перед переключением уровней запуска/целей загрузки или другими важными системными событиями.
- Правильно завершать процессы.
- Осведомленность об acpid.

Список используемых файлов, терминов и утилит

- `/etc/inittab`
- `shutdown`
- `init`
- `/etc/init.d/`
- `telinit`
- `systemd`
- `systemctl`
- `/etc/systemd/`
- `/usr/lib/systemd/`
- `wall`

## Введение

Общей чертой операционных систем, следующих принципам дизайна Unix, является использование отдельных процессов для управления различными функциями системы. Эти процессы, называемые демонами (или, в более общем смысле, службами), также отвечают за расширенные функции, лежащие в основе операционной системы, такие как службы сетевых приложений (HTTP-сервер, обмен файлами, электронная почта и т. д.), базы данных, конфигурация по требованию и т. д. Хотя Linux использует монолитное ядро, многие низкоуровневые аспекты операционной системы затрагиваются демонами, такими как балансировка нагрузки и настройка брандмауэра.

Какие демоны должны быть активны, зависит от назначения системы. Набор активных демонов также должен быть изменяем во время выполнения, чтобы службы можно было запускать и останавливать без необходимости перезагрузки всей системы. Для решения этой проблемы каждый основной дистрибутив Linux предлагает некоторую форму утилиты управления службами для управления системой.

Службами можно управлять с помощью сценариев оболочки или программы и ее поддерживающих файлов конфигурации. Первый метод реализован стандартом `SysVinit`, также известным как `System V` или просто `SysV`. Второй метод реализован `systemd` и `Upstart`. Исторически менеджеры служб на основе `SysV` были наиболее используемыми в дистрибутивах Linux. Сегодня менеджеры служб на основе` `systemd` чаще встречаются в большинстве дистрибутивов Linux. Менеджер служб — это первая программа, запускаемая ядром во время процесса загрузки, поэтому его PID (идентификационный номер процесса) всегда равен 1.

## SysVinit

Менеджер сервисов на основе стандарта `SysVinit` предоставит предопределенные наборы состояний системы, называемые уровнями запуска, и соответствующие им файлы скриптов сервисов для выполнения. Уровни запуска нумеруются от 0 до 6 и обычно назначаются для следующих целей:

`Runlevel 0`: - Выключение системы.  
`Runlevel 1, s or single`: - Однопользовательский режим, без сетевых и других возможностей (режим обслуживания).  
`Runlevel 2, 3 or 4` - Многопользовательский режим. Пользователи могут входить в систему через консоль или сеть. Уровни запуска 2 и 4 используются нечасто.  
`Runlevel 5` - Многопользовательский режим. Он эквивалентен 3, плюс вход в графический режим.  
`Runlevel 6` - Перезагрузка системы.

Программа, отвечающая за управление уровнями выполнения и связанными с ними демонами/ресурсами, — `/sbin/init`. Во время инициализации системы программа `init` идентифицирует запрошенный уровень выполнения, определенный параметром ядра или в файле `/etc/inittab`, и загружает связанные скрипты, перечисленные там для данного уровня выполнения. Каждый уровень выполнения может иметь много связанных служебных файлов, обычно скрипты, которые находятся в каталоге `/etc/init.d/`. Поскольку не все уровни выполнения эквивалентны в разных дистрибутивах Linux, краткое описание назначения уровня выполнения также можно найти в дистрибутивах на основе `SysV`.

Синтаксис файла `/etc/inittab` использует следующий формат:
```
id:runlevels:action:process
```
![image](https://github.com/user-attachments/assets/85b247bd-020e-4167-ada2-a9c0cd3212de)


Идентификатор `id` — это общее имя длиной до четырех символов, используемое для идентификации записи. Запись `runlevels` — это список номеров уровней выполнения, для которых должно быть выполнено указанное действие. Термин `action` определяет, как `init` будет выполнять процесс, указанный термином `process`. Доступны следующие действия:

`boot`
Процесс будет выполнен во время инициализации системы. Поле runlevels игнорируется.

`bootwait`
Процесс будет выполнен во время инициализации системы, а init будет ждать его завершения, чтобы продолжить. Поле runlevels игнорируется.

`sysinit`
Процесс будет выполнен после инициализации системы, независимо от уровня выполнения. Поле runlevels игнорируется.

`wait`
Процесс будет выполнен для указанных уровней выполнения, а init будет ждать его завершения, чтобы продолжить.

`respawn`
Процесс будет перезапущен, если он был завершен.

`ctrlaltdel`
Процесс будет выполнен, когда процесс init получит сигнал SIGINT, срабатывающий при нажатии последовательности клавиш Ctrl+Alt+Del.

Уровень выполнения по умолчанию — тот, который будет выбран, если в качестве параметра ядра не указано ничего другого — также определяется в файле /etc/inittab в записи `id:x:initdefault`. **X** — это номер уровня выполнения по умолчанию. **Этот номер никогда не должен быть равен 0 или 6**, поскольку это приведет к выключению или перезагрузке системы сразу после завершения процесса загрузки. Типичный файл `/etc/inittab` показан ниже:

```
# Default runlevel
id:3:initdefault:

# Configuration script executed during boot
si::sysinit:/etc/init.d/rcS

# Action taken on runlevel S (single user)
~:S:wait:/sbin/sulogin

# Configuration for each execution level
l0:0:wait:/etc/init.d/rc 0
l1:1:wait:/etc/init.d/rc 1
l2:2:wait:/etc/init.d/rc 2
l3:3:wait:/etc/init.d/rc 3
l4:4:wait:/etc/init.d/rc 4
l5:5:wait:/etc/init.d/rc 5
l6:6:wait:/etc/init.d/rc 6

# Action taken upon ctrl+alt+del keystroke
ca::ctrlaltdel:/sbin/shutdown -r now

# Enable consoles for runlevels 2 and 3
1:23:respawn:/sbin/getty tty1 VC linux
2:23:respawn:/sbin/getty tty2 VC linux
3:23:respawn:/sbin/getty tty3 VC linux
4:23:respawn:/sbin/getty tty4 VC linux

# For runlevel 3, also enable serial
# terminals ttyS0 and ttyS1 (modem) consoles
S0:3:respawn:/sbin/getty -L 9600 ttyS0 vt320
S1:3:respawn:/sbin/mgetty -x0 -D ttyS1
```

Команда `telinit q` должна выполняться каждый раз после изменения файла `/etc/inittab`. Аргумент `q (или Q)` сообщает `init` о необходимости перезагрузить конфигурацию. Такой шаг важен для предотвращения остановки системы из-за неправильной конфигурации в `/etc/inittab`.

Скрипты, используемые `init` для настройки каждого уровня выполнения, хранятся в каталоге `/etc/init.d/`. Каждый уровень выполнения имеет связанный каталог в /etc/ с именами /etc/rc0.d/, /etc/rc1.d/, /etc/rc2.d/ и т. д., со скриптами, которые должны быть выполнены при запуске соответствующего уровня выполнения. Поскольку один и тот же скрипт может использоваться разными уровнями выполнения, файлы в этих каталогах являются просто символическими ссылками на фактические скрипты в /etc/init.d/. Кроме того, первая буква имени файла ссылки в каталоге уровня выполнения указывает, должна ли служба быть запущена или завершена для соответствующего уровня выполнения. Имя файла ссылки, начинающееся с буквы `K`, определяет, что служба будет остановлена ​​при входе на уровень выполнения (`kill`). Начинаясь с буквы `S`, служба будет запущена при входе на уровень выполнения (`start`). Например, каталог `/etc/rc1.d/` будет иметь много ссылок на сетевые скрипты, начинающиеся с буквы `K`, учитывая, что уровень выполнения `1` является однопользовательским уровнем выполнения без сетевого подключения.

Команда `runlevel` показывает текущий уровень запуска для системы. Команда `runlevel` показывает два значения, первое — предыдущий уровень запуска, второе — текущий уровень запуска:
```
$ runlevel
N 5
```
![image](https://github.com/user-attachments/assets/e03eb954-5720-405c-b059-cff0eac59905)

Буква N в выводе показывает, что уровень выполнения не менялся с момента последней загрузки. В этом примере текущий уровень выполнения системы — уровень выполнения 5.

Эту же программу `init` можно использовать для переключения между уровнями выполнения в работающей системе без необходимости перезагрузки. Команду `telinit` также можно использовать для переключения между уровнями выполнения. Например, команды `telinit 1`, `telinit s` или `telinit S` изменят систему на уровень выполнения `1`.
























