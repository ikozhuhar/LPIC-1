## 101.1 Определение и настройка аппаратной части

## Активация устройства

Если машина оснащена множеством устройств хранения данных, важно определить, какое из них имеет правильный загрузчик и должно быть первым в порядке загрузки устройств. Операционная система может не загрузиться, если неправильное устройство стоит первым в списке проверки загрузки BIOS.


## Проверка устройств в Linux

Когда часть оборудования не обнаруживается операционной системой, скорее всего, эта часть — или порт, к которому она подключена — неисправны. Когда часть оборудования обнаружена правильно, но все равно не работает должным образом, может быть проблема на стороне операционной системы. Поэтому одним из первых шагов при решении проблем, связанных с оборудованием, является проверка того, правильно ли операционная система обнаруживает устройство.

Существует два основных способа определения аппаратных ресурсов в системе Linux: использовать **команды** или **читать файлы** внутри специальных файловых систем.

## Команды для проверки:

Вывод команд `lspci` и `lsusb` состоит из списка всех устройств PCI и USB. Однако устройство может быть еще не полностью работоспособным, поскольку для для корректоной работы нужен драйверю.

```
lspci - Показывает все устройства, подключенные в данный момент к шине PCI.
lspci -s 02:00.0 -v - Больше подробностей о конкретном устройстве.
```
![image](https://github.com/user-attachments/assets/9c4cc94f-3af3-4c4f-ae27-467bcef28131)
![image](https://github.com/user-attachments/assets/23b9aa42-2f75-4087-b9c2-05ea466e1f5a)
![image](https://github.com/user-attachments/assets/1bc58dc8-367b-4055-97d3-444ebce95a5e)

```
lsusb - Выводит список устройств USB, подключенных в данный момент к машине.
lsusb -v -d 0bda:b85c - Больше подробностей о конкретном устройстве.
lsusb -t - С опцией -t команда отображает текущие сопоставления USB-устройств в виде иерархического дерева.
```

![image](https://github.com/user-attachments/assets/dbf7d590-6f1b-41ae-a988-016af717c91b)
![image](https://github.com/user-attachments/assets/b3f0f334-445f-4d06-a5c2-58511f8c210a)

Возможно, не все устройства имеют соответствующие модули, связанные с ними. Связь с некоторыми устройствами может осуществляться приложением напрямую, без посредничества, предоставляемого модулем. Тем не менее, в выводе, предоставленном lsusb -t, есть важная информация. Когда существует соответствующий модуль, его имя появляется в конце строки для устройства, как в `Driver=btusb`. Класс устройства определяет общую категорию, например, Устройство интерфейса пользователя, Беспроводная связь, Специфический класс поставщика, Массовое хранилище и т. д. Чтобы проверить, какое устройство использует модуль btusb, представленный в предыдущем листинге, номера `Bus` и `Dev` должны быть указаны в опции -s команды lsusb:
```
lsusb -s 01:3
```

## Mодули (драйвера)

Для правильной работы некоторых модулей (драйверов) требуются другие модули, как в случае с модулями для аудиоустройств `snd_hda_intel`:
```
lsmod
lsmod | fgrep -i snd_hda_intel
```

![image](https://github.com/user-attachments/assets/99ee169a-d775-4845-9129-f2befca70bc3)
![image](https://github.com/user-attachments/assets/ad1efa37-5ebb-4e0b-90c6-bcf7115ab351)


Команда `modprobe` может использоваться как для загрузки, так и для выгрузки модулей ядра:
```
sudo modprobe -r snd-hda-intel
```
![image](https://github.com/user-attachments/assets/a64b1aa4-d171-421a-b289-3dd8020a5b34)

Используя имя модуля в качестве единственного аргумента, команда modinfo показывает описание, файл, автора, лицензию, идентификацию, зависимости и доступные параметры для данного модуля. Настраиваемые параметры для модуля можно сделать постоянными, включив их в файл /etc/modprobe.conf или в отдельные файлы с расширением .conf в каталоге /etc/modprobe.d/. Опция -p заставит команду modinfo отображать все доступные параметры и игнорировать остальную информацию:

```
sudo modinfo snd-hda-intel
```

Если модуль вызывает проблемы, можно использовать файл `/etc/modprobe.d/blacklist.conf` для блокировки загрузки модуля. Например, чтобы предотвратить автоматическую загрузку модуля nouveau, необходимо добавить строку `blacklist` nouveau в файл `/etc/modprobe.d/blacklist.conf`. Это действие требуется, когда установлен фирменный модуль nvidia, а модуль по умолчанию nouveau следует отложить.

Вы можете изменить файл `/etc/modprobe.d/blacklist.conf`, который уже существует в системе по умолчанию. Однако предпочтительным методом является создание отдельного файла конфигурации, `/etc/modprobe.d/<module_name>.conf`, который будет содержать настройки, специфичные только для данного модуля ядра.




## Информационные файлы и файлы устройств

Команды `lspci`, `lsusb` и `lsmod` действуют как интерфейсы для чтения информации об оборудовании, хранящейся в операционной системе. Этот тип информации хранится в специальных файлах в каталогах /proc и /sys. Эти каталоги являются точками монтирования файловых систем, которые находятся только в пространстве ОЗУ, используемом ядром для хранения конфигурации времени выполнения и информации о запущенных процессах. Такие файловые системы не предназначены для обычного хранения файлов, поэтому они называются псевдофайловыми системами и существуют только во время работы системы. 

### /proc
содержит файлы с информацией о запущенных процессах и аппаратных ресурсах. Некоторые важные файлы в `/proc` для проверки оборудования:
```
**/proc/cpuinfo** содержит подробную информацию о ЦП, найденных операционной системой
**/proc/interrupts** список номеров прерываний на устройство ввода-вывода для каждого ЦП
/proc/ioports содержит список зарегистрированных в настоящее время используемых регионов портов ввода-вывода
/proc/dma выводит список зарегистрированных используемых каналов DMA (прямой доступ к памяти)
```


### /sys
хранение информации об устройстве и данных ядра, связанных с оборудованием


### /dev
каждый файл внутри /dev связан с системным устройством, в частности с устройствами хранения данных.


### udev
Съемные устройства обрабатываются подсистемой udev, которая создает соответствующие устройства в `/dev`. Ядро Linux захватывает событие обнаружения оборудования и передает его процессу udev, который затем идентифицирует устройство и динамически создает соответствующие файлы в `/dev`, используя предопределенные правила.

В текущих дистрибутивах Linux udev отвечает за идентификацию и настройку устройств, уже присутствующих во время включения машины (обнаружение холодного подключения, coldplug detection), и устройств, идентифицированных во время работы системы (обнаружение горячего подключения, hotplug detection). Udev использует SysFS, псевдофайловую систему для информации, связанной с оборудованием, смонтированную в /sys.

При обнаружении новых устройств `udev` ищет соответствующее правило в предопределенных правилах, хранящихся в каталоге `/etc/udev/rules.d/`. Наиболее важные правила предоставляются дистрибутивом, но для особых случаев могут быть добавлены новые.





## Дополнительная информация

1. [Диагностика оборудования и системы](https://www.altlinux.org/%D0%94%D0%B8%D0%B0%D0%B3%D0%BD%D0%BE%D1%81%D1%82%D0%B8%D0%BA%D0%B0_%D0%BE%D0%B1%D0%BE%D1%80%D1%83%D0%B4%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F_%D0%B8_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B)
2. [16 команд для проверки аппаратной части в Linux](https://rus-linux.net/MyLDP/admin/commands.html)
3. [9 команд для проверки информации о CPU в Linux](https://habr.com/ru/companies/otus/articles/581796/)
4. [Информация о железе в Linux](https://serverspace.ru/support/help/informacziya-o-zheleze-v-linux/?utm_source=google.com&utm_medium=organic&utm_campaign=google.com&utm_referrer=google.com)
